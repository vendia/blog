# Trigger Site deployment for preview
name: Deploy Preview

on:
  # Push to any tracked branches
  push:
    branches: [ master ]
  # PRs only on master branch
  pull_request:
    branches: [ master ]
  # Manual trigger from the UI
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        description: 'Which environment?'
        required: true
        options:
          - staging-preview
          - staging
          - prod-preview
          # - prod
      message:
        description: 'Reason for manual deploy?'
        required: true

env:
  FORCE_COLOR: true # Show colors for link checker
  PREVIEW_ENV: staging-preview

# Automatically cancel in-progress actions on the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.event_name == 'pull_request_target' && github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  #################################################
  ## Check for code changes & abort if no changes
  #################################################
  setup:
    # exit early if [skip ci]
    if: "!contains(github.event.commits[0].message, '[skip-ci]')"
    runs-on: ubuntu-latest
    # Set job outputs to values from filter step
    outputs:
      # Code Changes
      changedFiles: ${{ steps.filter.outputs.any_files }}
      anythingChanged: ${{ steps.filter.outputs.any }}
      postsChanged: ${{ steps.filter.outputs.posts }}
      releasesChanged: ${{ steps.filter.outputs.releases }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          fetch-depth: 2 # We need to fetch with a depth of 2 for pull_request so we can do HEAD^2
      ## Check if files we care about have changed. Uses https://github.com/micromatch/picomatch#extglobs syntax
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          list-files: shell
          filters: |
            any:
              - '**'
            ## Check for post changes
            posts:
              - 'posts/**.md'
            ## Check for releases post changes
            releases:
              - 'releases/**.md'

  # Verify files are ok.
  test:
    runs-on: ubuntu-latest
    needs: setup
    if: ${{needs.setup.outputs.anythingChanged == 'true' || github.event.inputs.environment != ''}}
    timeout-minutes: 4
    steps:
    - uses: actions/checkout@v2.3.2
    - uses: bahmutov/npm-install@v1
      with:
        useLockFile: false
    - run: npm t

  # generate UUID to deploy previews to
  # trigger remote CI and wait
  ## Pass in current branch name as input
  # Then add comment to PR with deploy URL
  
  # Trigger deployment
  deploy-site:
    runs-on: ubuntu-latest
    needs: test
    name: Run remote action & wait for site to deploy
    steps:
      - name: Get branch name
        id: branch-name
        uses: tj-actions/branch-names@v5.1
      # Gather values for deployment
      - name: Get Deploy info
        id: deploy-info
        run: |
          # Set DEPLOY_CONTEXT. Passed in value or default PREVIEW_ENV
          DEPLOY_CONTEXT=${{ github.event.inputs.environment || env.PREVIEW_ENV }}
          BRANCH_SLUG=$(echo "${{ steps.branch-name.outputs.current_branch }}" | tr '[:upper:]' '[:lower:]')
          DEPLOY_URL="https://$DEPLOY_CONTEXT-${{ steps.deploy-info.outputs.branchSlug }}--vendia-site.netlify.app"

          echo "─────────────────────────────────────────────────"
          echo "Running on: ${{ steps.branch-name.outputs.current_branch }}"
          echo "BRANCH_SLUG '$BRANCH_SLUG'"
          echo "DEPLOY_URL '$DEPLOY_URL'"
          echo "─────────────────────────────────────────────────"

          # Set Outputs
          echo "::set-output name=branchSlug::$BRANCH_SLUG"
          echo ::set-output name=deployContext::$DEPLOY_CONTEXT
          echo "::set-output name=deployUrl::$DEPLOY_URL"
    
      # Welcome message for new folks
      # - uses: actions/first-interaction@v1
      #   with:
      #     repo-token: ${{ secrets.GITHUB_TOKEN }}
      #     issue-message: 'Hi thanks for creating your first issue! We will review this shortly!'
      #     pr-message: 'Congratulations for making your first PR on the Vendia Blog! We will review it soon.'

      # Initial Status Comment
      - name: Add status comment to PR
        if: github.event_name == 'pull_request' && github.ref != 'refs/heads/master' && needs.setup.outputs.hasSkipDeploy != 'true'
        id: status_comment_start
        uses: marocchino/sticky-pull-request-comment@v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          number: ${{ github.event.issue.number }}
          header: statusComment
          message: |
            Preview deploying... Should be live here soon at:

            ${{ steps.deploy-info.outputs.deployUrl }}

            Running CI job in https://github.com/vendia/site/actions/workflows/ci.yml. Check here for details.

      # Deploy the site and wait
      - name: Run remote action
        uses: convictional/trigger-workflow-and-wait@v1.3.0
        with:
          owner: vendia
          repo: site
          github_token: ${{ secrets.VENDIA_SITE_GITHUB_ACCESS_TOKEN }}
          # https://github.com/vendia/site/blob/master/.github/workflows/ci.yml
          workflow_file_name: ci.yml
          ref: master
          propagate_failure: true
          trigger_workflow: true
          wait_workflow: true
          inputs: '{"environment": "${{ steps.deploy-info.outputs.deployContext }}", "blogBranch": "${{ steps.branch-name.outputs.current_branch }}", "message": "${{ github.event.inputs.message }}, "urlPostFix": "${{ steps.deploy-info.outputs.branchSlug }}"}'

      # Updated Status Comment
      - name: Add status comment to PR
        if: github.event_name == 'pull_request' && github.ref != 'refs/heads/master'
        id: status_comment
        uses: marocchino/sticky-pull-request-comment@v1
        with:
          GITHUB_TOKEN: ${{ secrets.VENDIA_SITE_GITHUB_ACCESS_TOKEN }}
          number: ${{ github.event.issue.number }}
          header: statusComment
          message: |
            View the preview URL here.

            https://staging-preview-${{ steps.deploy-info.outputs.branchSlug }}--vendia-site.netlify.app/blog

            https://staging-preview-${{ steps.deploy-info.outputs.branchSlug }}--vendia-site.netlify.app/releases