# Manually trigger tests
name: Validate Markdown Contents

on:
  # Manual trigger from the UI
  workflow_dispatch:

env:
  FORCE_COLOR: true

# Automatically cancel in-progress actions on the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.event_name == 'pull_request_target' && github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  # Verify files are ok.
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 6
    steps:
    - uses: actions/checkout@v2.3.2
    # Install dependencies
    - uses: bahmutov/npm-install@v1
    # Run tests
    - run: npm t
    - id: set_var
      if: failure()
      run: |
        content=`cat ./errors.json`
        # the following lines are only required for multi line json
        content="${content//'%'/'%25'}"
        content="${content//$'\n'/'%0A'}"
        content="${content//$'\r'/'%0D'}"
        # end of optional handling for multi line json
        echo "::set-output name=packageJson::$content"
    # Add comment
    - name: Add PR error comment
      if: failure()
      uses: actions/github-script@v3
      with:
        github-token: ${{secrets.GITHUB_TOKEN}}
        script: |
          const errors = ${{fromJson(steps.set_var.outputs.packageJson)}}
          console.log('errors', errors)
          // Write to PR
          github.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: ' Ups, something went wrong. Please checkout the following error:  ' + errors
          });