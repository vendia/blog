# Manually trigger tests
name: Validate Markdown Contents

on:
  # Manual trigger from the UI
  workflow_dispatch:

env:
  FORCE_COLOR: true

# Automatically cancel in-progress actions on the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.event_name == 'pull_request_target' && github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  # Verify files are ok.
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 6
    steps:
    - uses: actions/checkout@v2.3.2
    # Install dependencies
    - uses: bahmutov/npm-install@v1
    # Run tests
    - run: npm t
    - id: set_var
      if: failure()
      run: |
        content=`cat ./errors.json`
        # the following lines are only required for multi line json
        content="${content//'%'/'%25'}"
        # content="${content//$'\n'/'%0A'}"
        content="${content//$'\r'/'%0D'}"
        echo ERRORS_JSON=$content >> $GITHUB_OUTPUT
    - name: Get value
      if: failure()
      run: echo '${{ steps.set_var.outputs.ERRORS_JSON }}'
    - name: Add test failure status comment to PR
      if: ${{ failure() }}
      id: status_comment_test_failure
      uses: marocchino/sticky-pull-request-comment@v1
      with:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        number: ${{ github.event.issue.number }}
        header: testStatusComment
        message: |
          ‚ùå Deploy failed!


          ${{ steps.set_var.outputs.ERRORS_JSON }}

          For additional information see Logs in 
          - https://github.com/vendia/blog/actions/workflows/test.yml
          - https://github.com/vendia/site/actions/workflows/ci.yml

    # # Add comment
    # - name: Add PR error comment
    #   if: failure()
    #   uses: actions/github-script@v6
    #   with:
    #     github-token: ${{secrets.GITHUB_TOKEN}}
    #     script: |
    #       // Write to PR
    #       github.issues.createComment({
    #         issue_number: context.issue.number,
    #         owner: context.repo.owner,
    #         repo: context.repo.repo,
    #         body: 'Ups, something went wrong. Please checkout the following error: ${{ steps.set_var.outputs.ERRORS_JSON }}'
    #       });